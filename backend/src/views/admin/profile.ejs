<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#117dd4"
          }
        }
      }
    };
  </script>
  <%- include('../partials/admin-styles') %>
</head>
<body class="bg-gray-50">
  <% const currentPage = 'profile'; %>

  <%- include('../partials/admin-mobile-header') %>

  <% if (user.role === 'user') { %>
    <%- include('../partials/community-sidebar') %>
  <% } else { %>
    <%- include('../partials/admin-sidebar') %>
  <% } %>

  <!-- Main Content -->
  <div class="lg:ml-64 min-h-screen pt-14 lg:pt-0">
    <!-- Top Bar -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
      <h2 class="text-2xl font-bold text-gray-900">Edit Profile</h2>
      <p class="text-sm text-gray-600">Update your name and bio</p>
    </div>

    <!-- Page Content -->
    <div class="p-6">
      <div class="max-w-2xl">
        <!-- Success/Error Messages -->
        <% if (success) { %>
          <div class="mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
            <%= success %>
          </div>
        <% } %>

        <% if (error) { %>
          <div class="mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg">
            <%= error %>
          </div>
        <% } %>

  <!-- Profile Form -->
  <div class="bg-white shadow-sm rounded-lg border border-gray-200">
    <form action="/admin/profile" method="POST" class="p-6">

      <!-- Current User Info -->
      <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-lg font-semibold text-gray-900 mb-2">Account Information</h3>
        <div class="space-y-2 text-sm">
          <div>
            <span class="font-medium text-gray-600">Email:</span>
            <span class="text-gray-900"><%= user.email %></span>
          </div>
          <div>
            <span class="font-medium text-gray-600">Role:</span>
            <span class="text-gray-900 capitalize"><%= user.role %></span>
          </div>
        </div>
      </div>

      <!-- Editable Fields -->
      <div class="space-y-6">
        <!-- Name Field -->
        <div>
          <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
            Full Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            id="name"
            name="name"
            value="<%= user.name %>"
            required
            minlength="2"
            maxlength="100"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
            placeholder="Enter your full name"
          >
          <p class="mt-1 text-sm text-gray-500">
            This will be displayed throughout the admin panel
          </p>
        </div>

        <!-- Bio Field -->
        <div>
          <label for="bio" class="block text-sm font-medium text-gray-700 mb-2">
            Bio
          </label>
          <textarea
            id="bio"
            name="bio"
            rows="4"
            maxlength="500"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
            placeholder="Tell us a bit about yourself (optional)"
          ><%= user.bio %></textarea>
          <p class="mt-1 text-sm text-gray-500">
            <span id="bioCounter">0</span>/500 characters
          </p>
        </div>

        <!-- Password Change Section -->
        <div class="border-t border-gray-200 pt-6 mt-8">
          <h3 class="text-lg font-semibold text-gray-900 mb-4">Change Password</h3>
          <p class="text-sm text-gray-600 mb-6">Leave blank to keep your current password</p>

          <div class="space-y-4">
            <!-- Current Password -->
            <div>
              <label for="currentPassword" class="block text-sm font-medium text-gray-700 mb-2">
                Current Password
              </label>
              <input
                type="password"
                id="currentPassword"
                name="currentPassword"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                placeholder="Enter your current password"
              >
            </div>

            <!-- New Password -->
            <div>
              <label for="newPassword" class="block text-sm font-medium text-gray-700 mb-2">
                New Password
              </label>
              <input
                type="password"
                id="newPassword"
                name="newPassword"
                minlength="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                placeholder="Enter new password (minimum 6 characters)"
              >
            </div>

            <!-- Confirm New Password -->
            <div>
              <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 mb-2">
                Confirm New Password
              </label>
              <input
                type="password"
                id="confirmNewPassword"
                name="confirmNewPassword"
                minlength="6"
                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                placeholder="Confirm your new password"
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center justify-between pt-6 border-t border-gray-200 mt-8">
        <a
          href="/admin/dashboard"
          class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors"
        >
          Cancel
        </a>
        <button
          type="submit"
          class="px-6 py-2 text-sm font-medium text-white bg-primary rounded-lg hover:bg-primary/90 focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors"
        >
          Update Profile
        </button>
      </div>
    </form>
  </div>

  <!-- Additional Info -->
  <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <div class="flex items-start gap-3">
      <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div class="text-sm text-blue-800">
        <p class="font-medium mb-1">Note:</p>
        <p>Your email address cannot be changed. If you need to update your email, please contact the administrator.</p>
      </div>
    </div>
  </div>
</div>

<script>
  // Bio character counter
  document.addEventListener('DOMContentLoaded', function() {
    const bioTextarea = document.getElementById('bio');
    const bioCounter = document.getElementById('bioCounter');

    function updateCounter() {
      const length = bioTextarea.value.length;
      bioCounter.textContent = length;

      // Update color based on length
      if (length > 450) {
        bioCounter.style.color = '#dc2626'; // red
      } else if (length > 400) {
        bioCounter.style.color = '#ea580c'; // orange
      } else {
        bioCounter.style.color = '#6b7280'; // gray
      }
    }

    // Initial count
    updateCounter();

    // Update on input
    bioTextarea.addEventListener('input', updateCounter);

    // Password validation
    const currentPassword = document.getElementById('currentPassword');
    const newPassword = document.getElementById('newPassword');
    const confirmNewPassword = document.getElementById('confirmNewPassword');
    const form = document.querySelector('form');

    function validatePasswords() {
      const current = currentPassword.value;
      const newPass = newPassword.value;
      const confirmPass = confirmNewPassword.value;

      // Reset custom validity
      currentPassword.setCustomValidity('');
      newPassword.setCustomValidity('');
      confirmNewPassword.setCustomValidity('');

      // If any password field is filled, all password fields are required
      if (current || newPass || confirmPass) {
        if (!current) {
          currentPassword.setCustomValidity('Current password is required when changing password');
        }
        if (!newPass) {
          newPassword.setCustomValidity('New password is required');
        }
        if (!confirmPass) {
          confirmNewPassword.setCustomValidity('Password confirmation is required');
        }
        if (newPass && confirmPass && newPass !== confirmPass) {
          confirmNewPassword.setCustomValidity('Passwords do not match');
        }
        if (newPass && newPass.length < 6) {
          newPassword.setCustomValidity('Password must be at least 6 characters long');
        }
      }
    }

    // Add event listeners for password validation
    [currentPassword, newPassword, confirmNewPassword].forEach(field => {
      field.addEventListener('input', validatePasswords);
      field.addEventListener('blur', validatePasswords);
    });

    // Validate on form submit
    form.addEventListener('submit', function(e) {
      validatePasswords();
      if (!form.checkValidity()) {
        e.preventDefault();
      }
    });
  });
</script>

      </div>
    </div>
  </div>

  <%- include('../partials/admin-scripts') %>
</body>
</html>